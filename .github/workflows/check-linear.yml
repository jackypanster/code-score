# ============================================================================
# Linear Issue Validation Workflow (Pilot Implementation)
# ============================================================================
#
# Purpose: å¼ºåˆ¶ PR ä¸ Linear å¡ç‰‡å…³è”ï¼Œç¡®ä¿ä»£ç å¯è¿½æº¯æ€§
# Strategy: æ–¹æ¡ˆ 2 - Reusable Workflowsï¼ˆå½“å‰ä¸ºè¯•ç‚¹ç‰ˆæœ¬ï¼Œå®Œæ•´å®ç°ï¼‰
#
# è®¾è®¡ç†å¿µï¼š
# 1. PR å¿…é¡»åœ¨æ ‡é¢˜ä¸­åŒ…å« Linear å¡å·ï¼ˆå¦‚ LINEAR-123ï¼‰
# 2. éªŒæ”¶å‰ç½®ï¼šåªæœ‰é€šè¿‡ Linear éªŒæ”¶çš„ä»£ç æ‰èƒ½åˆ›å»º PR
# 3. è´¨é‡é—¨ç¦ï¼šLinear æ˜¯è´¨é‡æ£€æŸ¥çš„åœ°æ–¹ï¼ŒGitHub PR æ˜¯æˆæœå±•ç¤ºçš„åœ°æ–¹
#
# åç»­è¿ç§»è®¡åˆ’ï¼š
# éªŒè¯é€šè¿‡åï¼Œå°†æ­¤å·¥ä½œæµæŠ½å–ä¸º reusable workflowï¼Œå­˜æ”¾åœ¨ç»„ç»‡çº§åˆ«çš„
# .github-workflows ä»“åº“ï¼Œå…¶ä»–é¡¹ç›®é€šè¿‡ workflow_call è°ƒç”¨ã€‚
#
# å‚è€ƒæ–‡æ¡£ï¼š
# - Codex Ã— Claude Ã— Linear Workflow Playbook
# - GitHub Reusable Workflows: https://docs.github.com/actions/using-workflows/reusing-workflows
# ============================================================================

name: Validate Linear Issue

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-linear:
    runs-on: ubuntu-latest

    steps:
      # ========== æ­¥éª¤ 1ï¼šæå– Linear ID ==========
      - name: Extract Linear ID from PR title
        id: extract
        run: |
          echo "ğŸ” Checking PR title for Linear issue ID..."

          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # æå– LINEAR-XXX æ ¼å¼çš„å¡å·
          LINEAR_ID=$(echo "$PR_TITLE" | grep -oE 'LINEAR-[0-9]+' || echo "")

          if [ -z "$LINEAR_ID" ]; then
            echo "âŒ Error: PR title must contain a Linear issue ID"
            echo ""
            echo "Expected format examples:"
            echo "  âœ“ feat: add user authentication [LINEAR-123]"
            echo "  âœ“ fix: resolve memory leak (LINEAR-456)"
            echo "  âœ“ LINEAR-789 - refactor database layer"
            echo ""
            echo "Current PR title: $PR_TITLE"
            exit 1
          fi

          echo "linear_id=$LINEAR_ID" >> $GITHUB_OUTPUT
          echo "âœ… Found Linear ID: $LINEAR_ID"

      # ========== æ­¥éª¤ 2ï¼šæ£€æŸ¥ Linear å¡ç‰‡çŠ¶æ€ï¼ˆå¯é€‰ï¼‰==========
      # éœ€è¦é…ç½® LINEAR_API_KEY secret æ‰èƒ½å¯ç”¨
      - name: Check Linear issue status
        if: ${{ secrets.LINEAR_API_KEY != '' }}
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_ID: ${{ steps.extract.outputs.linear_id }}
        run: |
          echo "ğŸ” Checking Linear issue status..."

          # æ„å»º GraphQL æŸ¥è¯¢
          QUERY='query($id: String!) {
            issue(id: $id) {
              state { name }
              title
            }
          }'

          # è°ƒç”¨ Linear API
          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Authorization: $LINEAR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"$QUERY\",\"variables\":{\"id\":\"$LINEAR_ID\"}}")

          # æ£€æŸ¥ API å“åº”
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "âš ï¸  Warning: Failed to fetch Linear issue status"
            echo "Response: $RESPONSE"
            echo "Continuing without status check..."
            exit 0
          fi

          STATE=$(echo "$RESPONSE" | jq -r '.data.issue.state.name')
          TITLE=$(echo "$RESPONSE" | jq -r '.data.issue.title')

          echo "Linear Issue: $LINEAR_ID"
          echo "Title: $TITLE"
          echo "Status: $STATE"

          # åªå…è®¸ç‰¹å®šçŠ¶æ€çš„å¡ç‰‡åˆ›å»º PRï¼ˆéªŒæ”¶å‰ç½®åŸåˆ™ï¼‰
          if [[ "$STATE" != "In Progress" && "$STATE" != "In Review" ]]; then
            echo ""
            echo "âŒ Error: Linear issue must be in 'In Progress' or 'In Review' state"
            echo "Current state: $STATE"
            echo ""
            echo "æ ¹æ®éªŒæ”¶å‰ç½®åŸåˆ™ï¼Œåªæœ‰æ­£åœ¨å¼€å‘æˆ–å·²é€šè¿‡éªŒæ”¶çš„ä»»åŠ¡æ‰èƒ½åˆ›å»º PRã€‚"
            echo "è¯·å…ˆåœ¨ Linear ä¸­å°†ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸º 'In Progress' æˆ– 'In Review'ã€‚"
            exit 1
          fi

          echo "âœ… Linear issue status is valid"

      # ========== æ­¥éª¤ 3ï¼šéªŒè¯é€šè¿‡ï¼Œæ·»åŠ æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰==========
      - name: Add validation label
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['linear-validated']
              });
              console.log('âœ… Added linear-validated label');
            } catch (error) {
              console.log('âš ï¸  Could not add label:', error.message);
              // ä¸è¦å› ä¸ºæ ‡ç­¾å¤±è´¥è€Œå¯¼è‡´æ•´ä¸ªæ£€æŸ¥å¤±è´¥
            }

      # ========== æ­¥éª¤ 4ï¼šæ·»åŠ  Linear é“¾æ¥åˆ° PR æè¿° ==========
      - name: Add Linear link to PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const linearId = '${{ steps.extract.outputs.linear_id }}';
            const body = context.payload.pull_request.body || '';

            // æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å« Linear é“¾æ¥
            if (body.includes('linear.app/issue/')) {
              console.log('âœ… Linear link already present in PR description');
              return;
            }

            // åœ¨ PR æè¿°é¡¶éƒ¨æ·»åŠ  Linear é“¾æ¥
            const linearLink = `\n\n---\nğŸ”— **Related Linear Issue:** [${linearId}](https://linear.app/issue/${linearId})\n---\n\n`;
            const newBody = linearLink + body;

            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: newBody
              });
              console.log('âœ… Added Linear link to PR description');
            } catch (error) {
              console.log('âš ï¸  Could not update PR description:', error.message);
            }

      # ========== æœ€ç»ˆæ€»ç»“ ==========
      - name: Summary
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… Linear Issue Validation Passed"
          echo "=========================================="
          echo "Linear ID: ${{ steps.extract.outputs.linear_id }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo ""
          echo "æ­¤ PR ç¬¦åˆ Linear éªŒæ”¶å‰ç½®åŸåˆ™ï¼Œå¯ä»¥ç»§ç»­åˆå¹¶æµç¨‹ã€‚"
          echo "=========================================="
